#include "halleffect.h"
#include "adc.h"
#include <avr/pgmspace.h>

float halleffect_get_value(u16 rawADC) {
    static u16 min_adc_value = 536;
    static u16 max_adc_value = 876;

    // no floats allowed in flash memory. change to 16 bit integer please
    float distance_in_mm[] = {
        311.0708,38.509533,27.950544,23.88545,21.445393,19.740356,18.450329,17.425303,16.580284,15.865268,15.255254,14.72024,14.24523,13.825221,13.440212,13.090203,12.775196,12.48519,12.215184,11.960178,11.725173,11.510167,11.305162,11.110159,10.925154,10.75015,10.585147,10.430143,10.280139,10.140137,10.005134,9.875131,9.750128,9.630125,9.515122,9.405119,9.300117,9.195116,9.095113,9.000111,8.910108,8.8201065,8.735105,8.650103,8.565101,8.490099,8.415097,8.3400955,8.265094,8.190092,8.125091,8.060089,7.995088,7.930087,7.865085,7.8050838,7.7450824,7.690081,7.6350803,7.580079,7.5250773,7.470076,7.4200754,7.370074,7.320073,7.2700715,7.220071,7.1750693,7.1300683,7.0850673,7.0400667,6.995065,6.9550643,6.9150634,6.8700624,6.8250613,6.7900605,6.7550597,6.715059,6.675058,6.635057,6.600056,6.5650554,6.5300546,6.495054,6.460053,6.425052,6.3900514,6.3600507,6.33005,6.295049,6.2600484,6.2300477,6.200047,6.1700463,6.1400456,6.110045,6.0800443,6.0550437,6.030043,6.0000424,5.9700418,5.945041,5.9200406,5.89004,5.8650393,5.840039,5.815038,5.7900376,5.765037,5.7400365,5.715036,5.6900353,5.665035,5.6450343,5.6200337,5.595033,5.5750327,5.550032,5.5250316,5.505031,5.4850307,5.46503,5.4450297,5.420029,5.3950286,5.375028,5.3550277,5.335027,5.3150268,5.2950263,5.275026,5.2550254,5.235025,5.2150245,5.200024,5.185024,5.1650233,5.145023,5.1250224,5.105022,5.0900216,5.0750213,5.055021,5.0350204,5.01502,5.0000196,4.985019,4.9650187,4.9500184,4.935018,4.9150176,4.9000173,4.885017,4.8700166,4.855016,4.835016,4.8200154,4.805015,4.7900147,4.7750144,4.760014,4.7450137,4.7300134,4.715013,4.7000127,4.6850123,4.670012,4.6550117,4.6400113,4.625011,4.6100106,4.6000104,4.58501,4.5700097,4.5600095,4.545009,4.530009,4.5150084,4.500008,4.490008,4.4750075,4.460007,4.450007,4.4400067,4.4250064,4.410006,4.400006,4.3900056,4.3750052,4.360005,4.3500047,4.3400044,4.325004,4.3100038,4.3000035,4.2900033,4.280003,4.2650027,4.2500024,4.240002,4.230002,4.2200017,4.2100015,4.195001,4.180001,4.1700006,4.1600003,4.15,4.14,4.1299996,4.1199994,4.109999,4.099999,4.0849986,4.0699983,4.059998,4.049998,4.0399976,4.0299973,4.019997,4.009997,3.9999967,3.9899967,3.9799967,3.9699967,3.9599967,3.9499967,3.9399967,3.9299967,3.9199967,3.9099967,3.8999968,3.8899968,3.8799968,3.8699968,3.8599968,3.8499968,3.8399968,3.8299968,3.8199968,3.8099968,3.7999969,3.7899969,3.7799969,3.769997,3.759997,3.749997,3.739997,3.729997,3.719997,3.709997,3.699997,3.689997,3.679997,3.669997,3.659997,3.649997,3.639997,3.629997,3.619997,3.609997,3.599997,3.589997,3.579997,3.569997,3.559997,3.549997,3.539997,3.529997,3.5199971,3.5099971,3.4999971,3.4899971,3.4799972,3.4699972,3.4599972,3.4499972,3.4399972,3.4299972,3.4199972,3.4099972,3.3999972,3.3899972,3.3799973,3.3699973,3.3599973,3.3499973,3.3399973,3.3299973,3.3199973,3.3099973,3.2999973,3.2899973,3.2799973,3.2699974,3.2599974,3.2499974,3.2399974,3.2299974,3.2199974,3.2099974,3.1999974,3.1899974,3.1799974,3.1699975,3.1599975,3.1499975,3.1399975,3.1299975,3.1199975,3.1099975,3.0999975,3.0899975,3.0799975,3.0699975
    };

    if (rawADC < min_adc_value) {
        return 0.0f;
    }

    if (rawADC > max_adc_value) {
        return 0.0f;
    }

    return distance_in_mm[rawADC - min_adc_value];
}
